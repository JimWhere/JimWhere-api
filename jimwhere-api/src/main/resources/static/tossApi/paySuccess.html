<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>결제 성공</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h1>결제 성공 페이지</h1>
<pre id="paySuccessResult">confirm 요청 중...</pre>

<script>
    const backendBaseUrl = 'http://localhost:8081/api/v1/user';
    const paySuccessResult = document.getElementById('paySuccessResult');

    const token = localStorage.getItem('accessToken');

    if (!token) {
        paySuccessResult.textContent = '토큰이 없습니다. 먼저 로그인 후 다시 시도해주세요.';
    } else {
        // Toss가 넘겨준 쿼리스트링
        const urlParams = new URLSearchParams(window.location.search);
        const paymentKey = urlParams.get('paymentKey');
        const orderId = urlParams.get('orderId');
        const amount = Number(urlParams.get('amount'));

        confirmPayment(paymentKey, orderId, amount);
    }

    async function confirmPayment(paymentKey, orderId, amount) {
        try {
            const response = await axios.post(
                `${backendBaseUrl}/payments/success`,
                {
                    paymentKey,
                    orderId,
                    amount
                },
                {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                }
            );

            paySuccessResult.textContent = JSON.stringify(response.data, null, 2);
        } catch (error) {
            console.error('confirm error:', error);

            if (error.response) {
                // 백엔드에서 내려준 내용 그대로 출력
                paySuccessResult.textContent =
                    'confirm 중 오류 발생\n' +
                    'status: ' + error.response.status + '\n\n' +
                    JSON.stringify(error.response.data, null, 2);
            } else {
                paySuccessResult.textContent = 'confirm 중 오류 발생\n' + error;
            }
        }
    }
</script>
</body>
</html>
