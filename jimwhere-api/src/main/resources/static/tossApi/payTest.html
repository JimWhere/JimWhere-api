<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Toss 결제 테스트</title>
    <script src="https://js.tosspayments.com/v1"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h1>Toss 결제 테스트 (JWT 유저)</h1>
<button id="payTestButton">예약 + 결제하기</button>

<script>

    const backendBaseUrl = 'http://localhost:8081/api/v1/user';
    const payTestButton = document.getElementById('payTestButton');


    const token = localStorage.getItem('accessToken');

    payTestButton.addEventListener('click', handlePayClick);

    async function handlePayClick() {
        if (!token) {
            alert('토큰이 없습니다. 먼저 로그인 후 다시 시도해주세요.');
            return;
        }

        try {

            const reservationRequest = {
                roomCode: 1,
                roomTypeCode: 1,
                startAt: "2025-01-01T12:00:00",
                endAt: "2025-01-05T12:00:00",
                reservationAmount: 30000
            };

            const reservationResponse = await axios.post(
                `${backendBaseUrl}/reservations`,
                reservationRequest,
                {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                }
            );

            const reservationBody = reservationResponse.data;
            if (!reservationBody.success) {
                alert('예약 생성에 실패했습니다.\n' + JSON.stringify(reservationBody));
                return;
            }


            const reservationCode = reservationBody.data.reservationCode;

            // ================================
            // 2. 결제 준비(init) API 호출
            // ================================
            const initResponse = await axios.post(
                `${backendBaseUrl}/payments/init`,
                {
                    reservationCode: reservationCode   // ← 방금 받은 예약번호 사용
                },
                {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                }
            );

            // ApiResponse<T> 구조: { success, data, errorCode, message, timestamp }
            const initBody = initResponse.data;
            if (!initBody.success) {
                alert('결제 준비에 실패했습니다.\n' + JSON.stringify(initBody));
                return;
            }

            const data = initBody.data;

            const clientKey = data.clientKey;
            const orderId = data.orderId;
            const amount = data.amount;
            const orderName = data.orderName;
            const successUrl = data.successUrl;
            const failUrl = data.failUrl;


            const tossPayments = TossPayments(clientKey);


            tossPayments.requestPayment('CARD', {
                amount,
                orderId,
                orderName,
                successUrl,
                failUrl
            });
        } catch (error) {
            console.error('예약/결제 시작 중 오류:', error);

            if (error.response) {
                alert(
                    '예약/결제 시작 중 오류가 발생했습니다.\n' +
                    'status: ' + error.response.status + '\n' +
                    'body: ' + JSON.stringify(error.response.data)
                );
            } else {
                alert('예약/결제 시작 중 오류가 발생했습니다.\n' + error);
            }
        }
    }
</script>
</body>
</html>
